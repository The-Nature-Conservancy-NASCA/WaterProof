{% extends "menu.html" %} 
{% load i18n %}
{% load static from staticfiles %}
{% load bootstrap_tags %}
{% block extra_head %}
<link href="https://unpkg.com/smartwizard@5/dist/css/smart_wizard_all.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}lib/css/leaflet.css"/>
<link rel="stylesheet" href="{% static "geonode/css/leaflet/leaflet.defaultextent.css" %}"/>
<link rel="stylesheet" href="{{ STATIC_URL }}geonode/css/leaflet/Control.Coordinates.css"/>
<link rel="stylesheet" href="{{ STATIC_URL }}geonode/css/leaflet/Control.Loader.css"/>
<link rel="stylesheet" href="{{ STATIC_URL }}waterproof_intake/mathquill/mathquill.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}waterproof_intake/css/intake.css" />
{% endblock %}
{% block body_outer %}
<!--header-->
<div class="header-waterproof">
    <div class="row">
        <div class="col-sm-4">
            <h1>{% trans "Edit water intake" %}</h1>
        </div>
        <div class="col-sm-8">
            <h4 class="title-city">{% trans "Intake creation city" %}: <span>{{intake.city.name}}, {{intake.city.country.name}}</span> </h4>
        </div>
    </div>    
    <!--Begin Form-->
    <form id="form" method="POST" action="">
        {% csrf_token %}
        <!--Start smartwizard-->
        <div id="smartwizard">
            <!--panel of navigation-->
            <ul class="nav">
                <li>
                    <a class="nav-link" href="#step-1">
                        {% trans "Location" %}
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="#step-2">
                        {% trans "Infrastructure" %}
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="#step-3">
                        {% trans "Demand" %}
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="#step-4">
                        {% trans "External input" %}
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="#step-5">
                        {% trans "NbS area" %}
                    </a>
                </li>
            </ul>
            <!--Steps-->
            <div class="tab-content" id="autoAdjustHeightF">
                <!--Step 1-->
                <div id="step-1" class="tab-pane" role="tabpanel">
                    <div>
                        <h3>{% trans "Define water intake" %}
                            <button type="button" value="Help modal button step 1" data-toggle="modal" data-target="#HelpStep1" id="HelpModalBtnModal_step1" class="glyphicon glyphicon-question-sign" aria-hidden="true" style="outline:none; text-decoration:none; color: #0977ca; border-style: none; background-color:transparent;"></button>
                        </h3>
                        <p>{% trans "Please complete the fields to define your Water Intake" %}</p>
                    </div>
                    <!--Input Name -->
                    <div id="water_intake" class="form-group row">
                        <div id="div_id_name" class="col-sm-2">
                            <label for="id_name" class="required-field ">
                                {% trans "Name" %}
                            </label>
                        </div>
                        <div class="col-sm-10">
                            <input type="text" id="intakeName" name="name"  maxlength="100" class="form-control" id="id_name" value="{{intake.name}}">
                        </div>                        
                    </div>
                    <!--Input Desc -->
                    <div id="div_id_description" class="form-group row">
                        <div class="col-sm-2">
                            <label for="id_description" class="required-field ">
                                {% trans "Description" %}
                            </label>
                        </div>                        
                        <div class="col-sm-10">
                            <input type="text" id="intakeDesc" name="description"  maxlength="1024" class="form-control" id="id_description" value="{{intake.description}}">
                        </div>
                    </div>
                    <!--Input Source Name -->
                    <div id="div_id_water_source_name" class="form-group row">
                        <div class="col-sm-2">
                            <label for="id_description" class="col-form-label required-field ">
                                {% trans "Water source name" %}
                            </label>
                        </div>                        
                        <div class="col-sm-10">
                            <input type="text" id="waterSource" name="water_source_name"  maxlength="100" id="id_water_source_name" class="form-control" value="{{intake.water_source_name}}">
                        </div>
                    </div>
                    <!-- Map -->
                    <div>
                        <h4 class="text-primary">{% trans "Water intake location" %}</h4>
                    </div>
                    <div id="map">
                        <div class="row text-center">
                            <div id="analysisOptions" class="col-md-12 div-draw-basin">
                                <button type="button" value="draw basin" disabled class="btn btn-default" id="validateBtn">{% trans "Draw Basin" %}</button>
                            </div>
                        </div> 
                    </div>
                    <br>
                    <div class="row text-center">
                        <div class="col-md-12">
                            <button type="button" value="next" class="btn btn-primary" id="step1NextBtn">{% trans "Next" %}</button>
                        </div>
                    </div>
                </div>
                <!--Step 2-->
                <div id="step-2" class="tab-pane" role="tabpanel">
                    <div>
                        <h3>{% trans "Water intake infrastructure setup" %}
                            <button type="button" value="Help modal button step 2" data-toggle="modal" data-target="#HelpStep2" id="HelpModalBtnModal_step2" class="glyphicon glyphicon-question-sign" aria-hidden="true" style="outline:none; text-decoration:none; color: #0977ca; border-style: none; background-color:transparent;"></button>
                        </h3>
                        <p>{% trans "In this section you can build your water intake infrastructure and define operating cost functions. Note that in the drawing panel shows the river from which the water comes and that a series of icons representing the elements that can be part of your catchment system are provided." %}</p>
                        <br>
                        <p>{% trans "Select the elements that make up your capture system and click on the drawing area to add them; when finished, click validate graph." %}</p>
                    </div>
                    <!--Toolbar mxgraph-->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel panel-info">
                                <div class="panel-body text-center" id="toolbar"></div>
                            </div>
                        </div>                        
                    </div>
                    <div class="row">
                        <!--Graph-->
                        <div class="col-md-8 position-graph">
                            <span style="float:right;padding-right:36px;">
                                <input id="getdata" type="checkbox" />{% trans "Source" %}
                            </span>
                            <textarea id="xml" style="height:535px;width:100%;display:none;border-style:none;"></textarea>
                            <div class="panel panel-info">
                                <div class="panel-body" id="graph" tabindex="-1"
                                    style="height:535px;width:100%;overflow:scroll;cursor:default; outline:none;"></div>
                            </div>
                        </div>
                        <!--Panel Information Right-->
                        <div class="col-md-4 position-table">
                            <div class="panel panel-info">
                                <div class="panel-body">
                                    <!--Figure Name-->
                                    <div class="alert alert-info" role="alert">
                                        <h1 class="text-center" id="titleDiagram"></h1>
                                    </div>
                                    <!--ID Item-->
                                    <div class="form-group">
                                        <label>{% trans "ID" %}</label>
                                        <input type="number" id="idDiagram" min="" max="" class="form-control" disabled>
                                    </div>
                                    <!--Water transport-->
                                    <div class="form-group">
                                        <label>{% trans "% Transported water" %}</label>
                                        <input type="number" id="aguaDiagram" min="" max="" class="form-control" oninput="validateinput(this)" disabled>
                                    </div>
                                    <!--Sediments-->
                                    <div class="form-group">
                                        <label>{% trans "% Sediments retained" %}</label>
                                        <input type="number" id="sedimentosDiagram" min="" max="" class="form-control" oninput="validateinput(this)" disabled>
                                    </div>
                                    <!--Nitrogen-->
                                    <div class="form-group">
                                        <label>{%trans "% Nitrogen retained" %}</label>
                                        <input type="number" id="nitrogenoDiagram" class="form-control" oninput="validateinput(this)" disabled>
                                    </div>
                                    <!--Phosphorus-->
                                    <div class="form-group">
                                        <label>{% trans "% Phosphorus retained" %}</label>
                                        <input type="number" id="fosforoDiagram" class="form-control" oninput="validateinput(this)" disabled>
                                    </div> 
                                </div>
                            </div>
                            <button type="button" value="validate graph" class="btn btn-primary btn-block" id="saveGraph">{% trans "Validate graph" %}</button>
                        </div>
                    </div>
                    <div class="row" id="hideCostFuntion" style="display: none">
                        <div class="col-md-12">
                            <h4 class="text-primary">{% trans "Cost functions "%}
                                <button type="button" value="add cost" class="btn btn-primary btn-add-cost" data-toggle="modal" data-target="#CalculatorModal" id="ModalAddCostBtn">{% trans "Add Cost" %}</button>
                            </h4>
                            <p>{% trans "The infrastructure elements of the water intake system have associated operating and maintenance costs. You can modify them, discard them or add new costs." %}</p>
                            <table class="table table-striped table-bordered table-condensed" style="width: 100%;">
                                <thead>
                                    <tr class="info">
                                        <th scope="col" class="small text-center vat">{% trans "Function name" %}</th>
                                        <th scope="col" class="small text-center vat">{% trans "Function" %}</th>
                                        <th scope="col" class="small text-center vat">{% trans "Currency" %}</th>
                                        <th scope="col" class="small text-center vat">{% trans "Factor" %}</th>
                                        <th scope="col" class="small text-center vat">{% trans "Options" %}</th>
                                    </tr>
                                </thead>
                                <tbody id="funcostgenerate"></tbody>
                            </table>
                        </div>
                    </div>                                                
                    <br>
                    <div class="row text-center">
                        <div class="col-md-8">
                            <button type="button" value="previous" class="btn btn-primary" id="step2PrevBtn">{% trans "Previous" %}</button>
                            <button type="button" value="next" class="btn btn-primary" id="step2NextBtn">{% trans "Next" %}</button>
                        </div>
                    </div>
                </div>
                <!--Step 3-->
                <div id="step-3" class="tab-pane" role="tabpanel">
                    <!--Header-->
                    <div>
                        <h3>{% trans "Water demand"%}
                            <button type="button" value="Help modal button step 3" data-toggle="modal" data-target="#HelpStep3" id="HelpModalBtnModal_step3" class="glyphicon glyphicon-question-sign" aria-hidden="true" style="outline:none; text-decoration:none; color: #0977ca; border-style: none; background-color:transparent;"></button>
                        </h3>
                        <p>{% trans "Please indicate the demand (extraction) from your catchment. You can use the interpolation tool of the system or enter it manually." %} </p>
                    </div>
                    <!--navigation-->
                    <ul class="nav nav-tabs" id="minitabsInportalion">
                        <li {%if intake.demand_parameters.interpolation_type != 'MANUAL' %} class="active" {% endif %} >
                            <a data-toggle="tab" href="#automatic" id="btnAutomaticTab">{% trans "Interpolation wizard" %}</a>
                        </li>
                        <li {%if intake.demand_parameters.interpolation_type == 'MANUAL' %} class="active" {% endif %}>
                            <a data-toggle="tab" href="#manual" id="btnManualTab" >{% trans "Manual edit" %}</a>
                        </li>
                    </ul>
                    <!--contents tabs manual and automatic-->
                    <div class="tab-content">
                        <!--tab automatic-->
                        <div class="tab-pane fade {%if intake.demand_parameters.interpolation_type != 'MANUAL' %} in active {% endif %}" id="automatic">
                            <br>
                            <div class="form-group">
                                <div class="row">
                                    <!--Data analysis Insert-->
                                    <div class="col-md-8 position-graph">
                                        <h5 class="text-primary">{% trans "Data analysis" %}</h5>
                                        <p>{% trans "Please select the method you wish to use" %} </p>
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label>{% trans "Interpolation method" %} <span class="text-danger-wp">(*)</span>
                                                </label>
                                                    <select class="form-control" id="typeProcessInterpolation">
                                                    <option value="1">{% trans "Linear interpolation" %}</option>
                                                    <option value="2">{% trans "Potential interpolation" %}</option>
                                                    <option Value="3">{% trans "Exponential interpolation" %}</option>
                                                    <option Value="4">{% trans "Logistics interpolation" %}</option>
                                                </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label>{% trans "Number of years for time series  (10-100) Year" %} <span
                                                        class="text-danger-wp">(*)</span> </label>
                                                        <input type="number"   min="1" step="0" oninput="validity.valid||(value='');" max="100" class="form-control justify-number" id="numberYearsInterpolationValue">
                                                </div>
                                            </div>
                                        </div>
                                        <h5 class="text-primary">{% trans "Extraction" %}</h5>
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label>{% trans "Initial year" %}<span class="text-danger-wp">(*)</span> </label>
                                                    <input type="number" class="form-control justify-number" id="initialDataExtractionInterpolationValue">
                                                </div>
                                                <div class="col-md-6" id="finalColumnExtraction">
                                                    <label>{% trans "Final year" %}<span class="text-danger-wp">(*)</span> </label>
                                                    <input type="number" class="form-control justify-number" id="finalDataExtractionInterpolationValue">
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <p>{% trans "Clic the button text generate" %}
                                            <button type="button" value="generate" class="btn btn-primary" id="intakeWECB">{% trans "Generate" %}</button>
                                            </p>
                                        </div>
                                    </div>
                                    <!--Data analysis Results-->
                                    <div class="col-md-4 position-table">
                                        <h5 class="text-primary">{% trans "Results" %}</h5>
                                        <div style="max-height: 400px; overflow-y: auto;">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center" scope="col">{% trans "Year" %}</th>
                                                        <th class="text-center" scope="col">{% trans "Extraction Value (l/s)" %}</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="intakeECTAG"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--tab manual-->
                        <div class="tab-pane fade {%if intake.demand_parameters.interpolation_type == 'MANUAL' %} in active {% endif %}"" id="manual">
                            <br>
                            <div class="form-group">
                                <div class="row">
                                    <!--Input number of years-->
                                    <div class="col-md-6">
                                        <h5 class="text-primary">{% trans "Number of years for time series" %}</h5>
                                        <p>{% trans "You can edit the table manually" %}</p>
                                        <div class="form-group">
                                            <label>{% trans "Number of years  (10-100) Year" %} <span class="text-danger-wp">(*)</span> </label>
                                            <input type="number" min="1" step="0" oninput="validity.valid||(value='');" max="100"  class="form-control justify-number" id="intakeNIYMI">
                                        </div>
                                        <p>{% trans "Clic the button text generate" %}
                                        <button type="button" value="generate" class="btn btn-primary" id="intakeNIBYMI">{% trans "Generate" %}</button>
                                        </p>
                                    </div>
                                    <!--Results-->
                                    <div class="col-md-6">
                                        <h5 class="text-primary">{% trans "Results" %}</h5>
                                        <div style="max-height: 400px; overflow-y: auto;">
                                            <table class="table" >
                                                <thead>
                                                    <tr>
                                                        <th class="text-center" scope="col">{% trans "Year" %}</th>
                                                        <th class="text-center" scope="col">{% trans "Extraction Value (l/s)" %}</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="intakeWEMI">
                                                {% for y in extraction_result %}
                                                    <tr>
                                                        <th class="text-center" scope="row">{{y.0}}</th>
                                                        <td class="text-center">
                                                            <input name="manualInputData" yearValue="{{y.0}}" value={{y.1}} type="number" class="form-control justify-number">
                                                        </td>                                                        
                                                    </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div> 
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="row text-center">
                        <div class="col-md-8">
                            <button type="button" value="previous" class="btn btn-primary" id="step3PrevBtn">{%trans "Previous" %}</button>
                            <button type="button" value="next" class="btn btn-primary" id="step3NextBtn">{% trans "Next" %}</button>
                        </div>
                    </div>
                </div>
                <!--Step 4-->
                <div id="step-4" class="tab-pane" role="tabpanel">
                    <!--Header-->
                    <div>
                        <h3>{% trans "External inputs" %}
                            <button type="button" value="Help modal button step 4" data-toggle="modal" data-target="#HelpStep4" id="HelpModalBtnModal_step4" class="glyphicon glyphicon-question-sign" aria-hidden="true" style="outline:none; text-decoration:none; color: #0977ca; border-style: none; background-color:transparent;"></button>
                        </h3>
                        <p> <span id="ExternalNumbersInputs"></span> {% trans "External inputs to define" %}
                        </p>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <h4 class="text-primary">{% trans "Asignation" %}</h4>
                            <div class="form-group">
                                <label>{% trans "Type element for asignation" %}</label>
                                <select class="form-control" id="externalSelect"></select>
                            </div>
                            <div id="IntakeTDLE"></div>
                        </div>
                    </div>
                    <br>
                    <div class="row text-center">
                        <div class="col-md-12">
                            <button type="button" value="previous" class="btn btn-primary" id="step4PrevBtn">{% trans "Previous" %}</button>
                            <button type="button" value="next" class="btn btn-primary" id="step4NextBtn">{% trans "Next" %}</button>
                        </div>
                    </div>
                </div>
                <!--Step 5-->
                <div id="step-5" class="tab-pane" role="tabpanel">
                    <h3>{% trans "NbS implementation area"%}
                        <button type="button" value="Help modal button step 5" data-toggle="modal" data-target="#HelpStep5" id="HelpModalBtnModal_step5" class="glyphicon glyphicon-question-sign" aria-hidden="true" style="outline:none; text-decoration:none; color: #0977ca; border-style: none; background-color:transparent;"></button>
                    </h3>
                    <p>{% trans "You can delimit the area within the basin in which the implementation of Nature Based Solutions (NBS) will be considered. By default, the system will consider that the NBS can be implemented in the entire basin area. However, by clicking on the 'Delimit NBS implementation area' button the system will highlight the vertices of the basin so that you can define the area in which WaterProof will consider that NBS can be implemented." %}</p>
                    <p>{% trans "WaterProof also allows you to upload a spatial file in shp format that contains the polygon where NBS implementations are possible. When finished, click on 'Validate area'" %}</p>
                    <div class="row">
                        <!--Map-->
                        <div class="col-md-7 width-graph-5">
                            <div class="panel panel-danger">
                                <div id="mapid" style="width: 100%; height: 500px;"></div>
                            </div>
                        </div>
                        <!--Panel Information Right-->
                        <div class="col-md-5 width-info-5">
                            <div class="panel panel-default" style="height: auto;">
                                <div class="panel-body">
                                    <div class="alert-info" role="alert">
                                        <h3 class="text-center">{% trans "Intake area delimitation" %}</h3>
                                    </div>
                                    <p>{% trans "You can change the area"%}</p>
                                    <p>{% trans "To move area vertices" %}</p>
                                    <div class="text-center" style="padding-bottom: 15px;">
                                        <div class="text-center">
                                            <button type="button" value="manually area delimit" class="btn btn-primary" id="btnDelimitArea"> {%trans "Manually area delimit" %}</button>
                                            <p style="padding-left: 5px;padding-right: 5px;">{% trans "or" %}</p>                                        
                                            <div class="input-group">
                                                <span class="input-group-btn">
                                                    <span class="btn btn-default btn-file">
                                                        {% trans "Select a file" %}
                                                        <input id="intakeArea" type="file">
                                                    </span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <br>                                  
                                    <p>{% trans "To load shapefile" %}</p>
                                    <div class="text-center">
                                        <button type="button" value="validate delimit area" class="btn btn-primary" id="btnValidateArea"> {% trans "Validate delimit area" %}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="row text-center">
                        <div class="col-md-8">
                            <button type="button" value="previous" class="btn btn-primary" id="step5PrevBtn">{% trans "Previous" %}</button>
                            <input type="submit" id="submit" class="btn btn-primary" value="{% trans 'Save' %}"></input>
                        </div>
                    </div>
                </div>
            </div>
    
            <!--Inputs hidden for save data-->
            <input type="hidden" id="intakeCity" name="intakeCity" value="{{intake.city.pk}}">
            <input type="hidden" id="xmlGraph" name="xmlGraph" value="{{intake.xml_graph}}">
            <input type="hidden" id="graphConnections" name="graphConnections">
            <input type="hidden" id="isFile" name="isFile">
            <input type="hidden" id="typeDelimit" name="typeDelimit">
            <input type="hidden" id="waterExtraction" name="waterExtraction" value="">
            <input type="hidden" id="delimitArea" name="delimitArea" value="">
            <input type="hidden" id="pointIntake" name="pointIntake" value="">
            <input type="hidden" id="intakeAreaPolygon" name="intakeAreaPolygon" value="">
            <input type="hidden" id="graphElements" name="graphElements" value="">
            <input type="hidden" id="basinId" name="basinId" value="">
            <input type="hidden" id="intakeId" name="intakeId" value="">
    </form>
</div>
<!--Modal Calculator-->
<div class="modal fade" id="CalculatorModal" tabindex="-1" aria-labelledby="CalculatorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" value="close" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="CalculatorModalLabel"></h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <p>{% trans "Use this window to configure your cost function by selecting the variables of your interest: flow, concentration or loads." %}</p>
                        <p>{% trans "Expand the list of items and click to build the function." %}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-7">
                        <div class="form-group">
                            <label class="text-primary">{% trans "Cost function name" %}</label>
                            <input id="costFunctionName" type="text" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="text-primary">{% trans "Cost function description" %}</label>
                            <textarea id="costFuntionDescription" rows="3" class="form-control"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                <label class="text-primary">{% trans "Currency for definition of costs" %}</label>
                                <select id="currencyCost" class="form-control" required>
                                    {% for currency in currencies %}
                                        {% if currency.iso3 == 'USA'%}
                                            {% if currency.currency == intake.city.country.currency %}                                                
                                                <option value="{{currency.currency}}" data-country="{{currency.iso3}}" selected>({{currency.currency}}) - {{currency.name}}</option>
                                            {% else %}
                                                <option value="{{currency.currency}}" data-country="{{currency.iso3}}">({{currency.currency}}) - {{currency.name}}</option>
                                            {% endif %}                                            
                                        {% else %}
                                            {% if currency.currency == intake.city.country.currency %}
                                                <option value="{{currency.currency}}" attr="{{currency.currency}}" selected>({{currency.currency}}) - {{currency.name}} </option>
                                            {% else %}
                                                <option value="{{currency.currency}}">({{currency.currency}}) - {{currency.name}}</option>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-xs-6">
                                <label class="text-primary">{% trans "Multiplying factor for overrall cost" %} </label>

                                <input type="text" value="1.00" id="global_multiplier_factorCalculator" class="form-control">
                            </div>
                        </div>                         
                        <h5 class="text-primary keyboard-title">{% trans "Syntax keyboard" %}</h5>
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#mathBasic_tab" data-toggle="tab">{% trans "Basic" %}</a></li>
                            <li><a href="#mathAdvanced_tab" data-toggle="tab" >{% trans "Advanced" %}</a></li>
                        </ul>
                        <div class="tab-content">
                            <div id="mathBasic_tab" class="tab-pane fade in active">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="=">&#61</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="+">&#43</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="-">&#8722;</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="*">&#215</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="/">a/b</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="**">a^b</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="sqrt">&#8730</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="min()">min</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="max()">max</button>
                                </div>
                            </div>                            
                            <div id="mathAdvanced_tab" class="tab-pane fade in">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="pi">π</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="e">e</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="log()">ln</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="log10()">log</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="%">mod</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value=">">&#62;</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="<">&#60;</button>
                                    <button type="button" class="btn btn-default math-btn" name="mathKeyBoard" value="(expression) if (conditional) else (other_case)">if</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <label class="text-primary">{% trans "Infrastructure" %}</label>
                        <div class="panel-group" id="VarCostListGroup" style="max-height: 480px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <p><b>{% trans "Create / Edit function in Python Syntax." %}</b></p>
                        <p>{% trans "Click on the validate button to check the syntax of the function." %}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="mathNatural" class="tab-pane fade in active">
                            <textarea id="python-expression" class="python-expression" autocapitalize="off" autocomplete="off" 
                                    autocorrect="off" spellcheck="false" x-palm-disable-ste-all="true"></textarea>
                            <button value="validate" id="btnValidatePyExp">{% trans "Validate" %}</button>
                            <div id="MathPreview" class="preview" ></div>
                        </div>
                        <div id="mathLogical" class="tab-pane fade"></div>
                    </div>
                </div>
                <br>
                <div class="modal-footer">
                    <button type="button" value="close" class="btn btn-secondary" data-dismiss="modal">{% trans "Close" %}</button>
                    <button type="button" value="add cost" class="btn btn-primary" id="saveAndValideCost">{% trans "Add cost" %}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Modal Help Geom Files-->
<div class="modal fade" id="HelpGeom" tabindex="-1" aria-labelledby="HelpGeomLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" value="close" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h3 class="modal-title text-center" id="HelpGeomLabel">{% trans "Geom files help" %}</h3>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <ol>
                            <li value="1">{% trans "Only zip and GeoJSON"%}</li>
                            <li>{% trans "Only EPSG"%}</li>
                            <li>{% trans "Max upload size" %}</li>
                        </ol>
                    </div>
                </div>
                <br>
                <div class="modal-footer">
                    <button type="button" value="close" class="btn btn-secondary" data-dismiss="modal">{% trans "Close" %}</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!--Help Step1-->
<div class="modal fade" id="HelpStep1" tabindex="-1" aria-labelledby="HelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button value="close" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h3 class="modal-title text-center" id="HelpModalLabel" style="color:#6398C1 ;">{% trans "Define water intake" %}
                </h3>
            </div>
            <div class="modal-body">
                <p>
                    {% trans "This is the first step in creating a water intake. In addition to indicating its name, description and supplier source, a geographic viewer is provided to help you identify the most precise location of your catchment basin (you can move the icon" %} <img class="width-im-help-1" src="/static/lib/img/marker-icon.png" /> {% trans "on the map to define the water intake location or you can directly enter latitude and longitude coordinates)." %}
                </p>
                <p>
                    {% trans "With this information the system will calculate the polygon of the basin to be used by the InVest and ROIS models in the portfolio definition and ROI calculation:" %}
                </p>
                <img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/Step1.png" alt="help step 1"></img>
                
                <div>
                    <br>
                    <div class="modal-footer">
                        <button value="close" type="button" class="btn btn-secondary" data-dismiss="modal" style="color: white; background-color: #6398C1;">{% trans "Close" %}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Help Step2-->
<div class="modal fade" id="HelpStep2" tabindex="-1" aria-labelledby="HelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button value="close" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h3 class="modal-title text-center" id="HelpModalLabel" style="color:#6398C1 ;">{% trans "Define water intake" %}
                </h3>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">
                            {% trans "Element of the water intake system" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="how-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">
                            {% trans "Connections" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">
                            {% trans "Construction of the scheme"%}
                        </a>
                    </li>
                </ul>

                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade active in" id="home" role="tabpanel" aria-labelledby="overview-tab">
                        <!--Table Element of the water intake system-->
                        <table>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-1.png" alt="icon 1 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents a big reservoir, or structure that contains a large water reservoir, where river waters are stored." %}</td>
                            </tr>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-2.png" alt="icon 2 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents pumping mechanisms to pump water to deliver it to another element of the water intake system." %}</td>
                            </tr>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-3.png" alt="icon 3 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents a reservoir, in which water is deposited." %}</td>
                            </tr>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-4.png" alt="icon 4 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents a bottom intake in which the water collection is located horizontally and below the stream flow." %}</td>
                            </tr>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-5.png" alt="icon 5 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents a lateral intake in which the water collection is located on one side of the stream." %}</td>
                            </tr>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-6.png" alt="icon 6 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents a floating intake that is installed on top of a floating surface (slab), anchored to the bottom of the water body, and that allows to capture water." %}</td>
                            </tr>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-7.png" alt="icon 7 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents a sand trap that, by reducing the speed of the water, makes large particles fall under their own weight to the bottom of the sand trap to be removed." %}</td>
                            </tr>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-8.png" alt="icon 8 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents a breaking chamber in charge of reducing the pressure of the pipeline at a point along its path." %}</td>
                            </tr>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-9.png" alt="icon 9 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents the case study infrastructure where water treatment or other processes with costs to be included in the analysis are carried out." %}</td>
                            </tr>
                            <tr>
                                <td><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-10.png" alt="icon 10 help table step 2"></img>
                                </td>
                                <td>{% trans "Represents external inputs to the system in charge of making water contributions through hydraulic works of an emitting river basin to meet water requirements." %}</td>
                            </tr>

                        </table>
                    </div>
                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="how-tab">
                        <p>{% trans "Note that you must make the connections by clicking between the source element and the destination element. Right-click to indicate the type of connection:" %}</p>
                        <!--Table Connections-->
                        <table style="padding-top: none;">
                            <tr>
                                <td style="width: 50%;"><img style="margin: 10px auto 10px; display: block;" src="/static/geonode/img/creaeIntakeHelpTable-11.png" alt="icon 11 help table step 2"></img>
                                </td>
                                <td style="width: 50%;">
                                    <h5>{% trans "Channel:" %}</h5>
                                    <p>{% trans "To represent structures that collect the water and convey it to another element of the system." %}</p>
                                    <h5>{% trans "Piping:" %}</h5>
                                    <p>{% trans "Either rigid or flexible hoses, that are in the intake system operating either by pumping and / or re-pumping, or by gravity." %}</p>
                                    <h5>{% trans "Connection:" %}</h5>
                                    <p>{% trans "Where there is no pipe or channel type element that connects them, but it is required to symbolize their topological connection relationship." %}</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                        <!--Table Construction of the scheme-->
                        <table>
                            <tr>
                                <td style="width: 50%;">
                                    <p>1. {% trans "Click on the element you want to incorporate. Then click on the graphic board to include it in the scheme. Establish connections by clicking your mouse between elements:" %}</p>
                                    <img style="margin: 10px auto 10px; display: block; width: 60%; height: 70%;" src="/static/geonode/img/creaeIntakeHelpTable-12.png" alt="icon 12 help table step 2"></img>
                                </td>
                                <td style="width: 50%;">
                                    <p>2. {% trans "Once you have defined the connection, you can right click on the arrow to determine if it is a channel, a pipe, a connection or an extraction connection:" %}</p><img style="margin: 10px auto 10px; display: block; width: 60%; height: 70%;" src="/static/geonode/img/creaeIntakeHelpTable-13.png"></img>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 50%;">
                                    <p>3. {% trans "For each item, confirm or edit the values ​​of percentage of transported water, percentage of sediment retention, percentage of nitrogen retention, and percentage of phosphorus retention. These values ​​will influence the model calculations:" %}</p><img style="margin: 10px auto 10px; display: block; width: 80%; height: 70%;" src="/static/geonode/img/creaeIntakeHelpTable-14.png"></img>
                                    <p>{% trans "When your system is complete, click on the 'Validate chart' button." %}
                                    </p>
                                </td>
                                <td style="width: 50%;">
                                    <p>4. {% trans "For each item confirm or edit the operation and maintenance cost function. You can also create new cost functions." %}</p><img style="margin: 10px auto 10px; display: block; width: 80%; height: 70%;" src="/static/geonode/img/creaeIntakeHelpTable-15.png"></img>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div>
                    <br>
                    <div class="modal-footer">
                        <button value="close" type="button" class="btn btn-secondary" data-dismiss="modal" style="color: white; background-color: #6398C1;">{% trans "Close" %}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Help Step3 interpolation-->
<div class="modal fade" id="HelpStep3" tabindex="-1" aria-labelledby="HelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button value="close" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h3 class="modal-title text-center" id="HelpModalLabel" style="color:#6398C1 ;">{% trans "Definition of demand (extraction) of water in the water intake" %}
                </h3>
            </div>
            <div class="modal-body">
                <p>
                    {% trans "The system offers you several alternatives to define the demand (extraction) of water from your catchment:" %}
                </p>
                <p></p>
                <li>{% trans "Linear interpolation" %}</li>
                <li>{% trans "Potential interpolation" %}</li>
                <li>{% trans "Exponential interpolation" %}</li>
                <li>{% trans "Logarithmic interpolation" %}</li>
                <li>{% trans "Manually" %}</li>
                <p></p>
                <p>
                    {% trans "If you select the interpolation method, you must enter the number of years for which you want to estimate demand and the expected minimum and maximum demand flow (extraction) values ​​(unit in l / s):" %}
                </p>
                <img style="margin: 10px auto 10px; display: block; width: 70%;" src="/static/geonode/img/step3-1.png" alt="icon 1 help table step 3"></img>
                <p>
                    {% trans "If you know your water demand (withdrawal) data from year to year, you can enter it manually. For this, just enter the number of years for which you have information and WaterProof will generate a table in which you can enter the data (units in l / s):" %}
                </p>
                <img style="margin: 10px auto 10px; display: block; width: 60%;" src="/static/geonode/img/step3-2.png" alt="icon 2 help table step 3"></img>
                <div>
                    <br>
                    <div class="modal-footer">
                        <button value="close" type="button" class="btn btn-secondary" data-dismiss="modal" style="color: white; background-color: #6398C1;">{% trans "Close" %}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Help Step4 external inputs-->
<div class="modal fade" id="HelpStep4" tabindex="-1" aria-labelledby="HelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button value="close" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h3 class="modal-title text-center" id="HelpModalLabel" style="color:#6398C1 ;">{% trans "External input" %}
                </h3>
            </div>
            <div class="modal-body">
                <p>{% trans "The system offers you a selection list with each of the external inputs that you included in the drawing panel of the capture system. You must indicate for each external inlet the values ​​of volume of water (m3) that enters from them, as well as the annual contributions of sediment (Ton), nitrogen (Kg) and phosphorus (Kg)." %}</p>
                <img style="width: 80%; height: 80%; display: block;" src="/static/geonode/img/step3-3.png" alt="icon 1 help table step 4"></img>
                <div>
                    <br>
                    <div class="modal-footer">
                        <button value="close" type="button" class="btn btn-secondary" data-dismiss="modal" style="color: white; background-color: #6398C1;">{% trans "Close" %}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Help Step5-->
<div class="modal fade" id="HelpStep5" tabindex="-1" aria-labelledby="HelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button value="close" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h3 class="modal-title text-center" id="HelpModalLabel" style="color:#6398C1 ;">{% trans "Intake area delimitation" %}
                </h3>
            </div>
            <div class="modal-body">
                <p>
                    {% trans "To delimit the area within the basin in which it is possible to implement your Nature-Based Solutions, click on the 'Delimit NBS implementation area' button. The system will show you the polygon highlighted in red with vertices that you can move. The system will validate that your polygon is not outside the watershed." %}
                </p>
                <p>
                    {% trans "When you have finished making your changes, click on the 'Validate area' button." %}
                </p>
                <img style="margin: 10px auto 10px; display: block; width: 90%;" src="/static/geonode/img/step5.png" alt="icon 1 help table step 5"></img>
                <p>
                    {% trans "The system also offers you the option to upload a spatial file for loading shapefile containing the polygon where the NBS implementation is possible. The system will verify that the polygon is within the basin area and that it complies with the EPSG 3857 (world standard of flat coordinates) or the EPSG 4326 (world standard in geographic coordinates)." %}
                </p>
                <p>
                    {% trans "Files are accepted only in compressed .zip format whose required structure must contain at least: 1 .shp file, 1 .dbf file, 1 .prj file and 1 .shx file" %}
                </p>
                <div>
                    <br>
                    <div class="modal-footer">
                        <button value="close" type="button" class="btn btn-secondary" data-dismiss="modal" style="color: white; background-color: #6398C1;">{% trans "Close" %}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_script %}
<script type="text/javascript" src="{% url 'javascript-catalog-intake' %}"></script>
<script src="{% static "lib/js/leaflet.js" %}"></script>
<script src="{% static "geonode/js/leaflet/leaflet.defaultextent.js" %}"></script>
<script src="{{ STATIC_URL }}waterproof_intake/js/jquery.smartWizard.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}geonode/js/leaflet/Leaflet.Editable.js"></script>
<script src="{{ STATIC_URL }}geonode/js/leaflet/Leaflet.Coordinates.js"></script>
<script src="{{ STATIC_URL }}geonode/js/leaflet/Control.Loader.js"></script>
<script src="{{ STATIC_URL }}geonode/js/waterproof/waterIntake.js"></script>
<script src="{{ STATIC_URL }}geonode/js/waterproof/geomFile_validate.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<!--ZIP reader library-->
<script src="{{ STATIC_URL }}geonode/js/jszip/jszip.min.js"></script>
<!--Shapefile reader library -->
<script src="{{ STATIC_URL }}geonode/js/shp/shp.min.js"></script>
<script src="{{ STATIC_URL }}geonode/js/proj4js/proj4.js"></script>
<script type="text/javascript">
    var intakePolygons=[];
    var mxBasePath = '{{ STATIC_URL }}geonode/js/mxgraph/src';
    var mxImageBasePath = '{{ STATIC_URL }}geonode/js/mxgraph/examples/images';
    var editorUrl = '{{ STATIC_URL }}geonode/js/mxgraph/examples/editors/config/diagrameditor.xml';
    var serverApi = '{{serverApi}}';
    var lang = '{{LANGUAGE_CODE}}';
    let waterproof = {};
    OSM_BASEMAP_URL = '{{ OSM_BASEMAP_URL }} ';
    IMG_BASEMAP_URL = '{{ IMG_BASEMAP_URL }} ';
    HYDRO_BASEMAP_URL = '{{ HYDRO_BASEMAP_URL }} ';
    GRAY_BASEMAP_URL = '{{ GRAY_BASEMAP_URL }} ';
    GEOSERVER_WMS = '{{ GEOSERVER_WMS }}';
    HYDRO_NETWORK_LYR = '{{ HYDRO_NETWORK_LYR }}';
    MAX_NUM_POINTS = 500;
    var intakeInterpolationParams = {};
    intakeInterpolationParams.type = '{{ intake.demand_parameters.interpolation_type }}';
    intakeInterpolationParams.yearsNum = '{{intake.demand_parameters.years_number}}';
    intakeInterpolationParams.initialExtract = parseFloat('{{intake.demand_parameters.initial_extraction}}');
    intakeInterpolationParams.endingExtract = parseFloat('{{intake.demand_parameters.ending_extraction}}');
    var xmlGraph = $('#xmlGraph').val();
    var intakeExternalInputs = '{{externalInputs|safe}}' == "" ? "" : JSON.parse('{{externalInputs|safe}}');
    var intakeObject = {};
    intakeObject.id = '{{intake.id}}';
    $('#intakeId').val(intakeObject.id);
    intakeObject.polygon = '{{intake.polygon_set.first.geomIntake|safe}}';
    intakeObject.point = '{{intake.polygon_set.first.geomPoint|safe}}' == "" ? "" : JSON.parse('{{intake.polygon_set.first.geomPoint|safe}}');
    intakeObject.delimitArea='{{intake.polygon_set.first.geom}}';
    intakeObject.basin='{{intake.polygon_set.first.basin.pk}}';
    intakePolygons.push(intakeObject);
    var defaultCurrencyId = '233';
    var defaultCurrentyName = '(USD) - United States';
    var simplifyTolerance = 0.01;
</script>

<script src="{{ STATIC_URL }}geonode/js/leaflet/leaflet-omnivore.min.js"></script>
<script src="{{ STATIC_URL }}waterproof_intake/js/intake_edit.js"></script>
<script src="{{ STATIC_URL }}waterproof_intake/js/graph_edit.js"></script>
<script src="{{ STATIC_URL }}waterproof_intake/js/graphValidations.js"></script>
<script src="{{ STATIC_URL }}geonode/js/mxgraph/mxClient.js"></script>
<script src="{{ STATIC_URL }}geonode/js/mxgraph/examples/editors/js/app.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="{{ STATIC_URL }}geonode/js/mxgraph/examples/editors/js/app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

{% endblock %}